{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}

<style>
  header {
    background-color: #2c3e50;
    color: #fff;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
</style>

<div class="container mt-5">
  <div class="card shadow border-0">

    <!-- ⚙️ Admin Header Navigation -->
    <header>
      <div><strong>Admin Panel</strong></div>
      <nav>
        <a href="{{ url_for('admin_dashboard', status='pending') }}" class="btn btn-sm me-2 {{ 'btn-warning text-white' if status == 'pending' else 'btn-outline-warning' }}">Pending</a>
        <a href="{{ url_for('admin_dashboard', status='approved') }}" class="btn btn-sm me-2 {{ 'btn-success' if status == 'approved' else 'btn-outline-success' }}">Approved</a>
        <a href="{{ url_for('admin_dashboard', status='rejected') }}" class="btn btn-sm {{ 'btn-danger' if status == 'rejected' else 'btn-outline-danger' }}">Rejected</a>
        <a href="{{ url_for('approve_items') }}" class="btn btn-outline-secondary btn-sm">Approve Items</a>
        <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
      </nav>
    </header>

    <!-- 📊 Admin Summary -->
    <div class="row text-center mt-4 mb-4">
      <div class="col">
        <div class="card shadow-sm border-0 p-3">
          <h6>Total Items</h6>
          <h4>{{ total_count }}</h4>
        </div>
      </div>
      <div class="col">
        <div class="card shadow-sm border-0 p-3">
          <h6>Pending</h6>
          <h4>{{ pending_count }}</h4>
        </div>
      </div>
      <div class="col">
        <div class="card shadow-sm border-0 p-3">
          <h6>Approved</h6>
          <h4>{{ approved_count }}</h4>
        </div>
      </div>
      <div class="col">
        <div class="card shadow-sm border-0 p-3">
          <h6>Rejected</h6>
          <h4>{{ rejected_count }}</h4>
        </div>
      </div>
    </div>

    <!-- 🔍 Search & Filters -->
    <form method="get" action="{{ url_for('admin_dashboard') }}" class="row g-3 align-items-center mb-4">
      <div class="col-md-6">
        <input type="text" name="search" class="form-control" placeholder="Search item or uploader" value="{{ search }}">
      </div>
      <input type="hidden" name="status" value="{{ status }}">
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Search</button>
      </div>
    </form>

    <!-- 📦 Items List -->
    <h5 class="mb-3">Item Submissions</h5>
    <ul class="list-group mb-4">
      {% for item in items.items %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div style="flex: 1;">
          <strong>{{ item.name }}</strong><br>
          <small class="text-muted">by {{ item.user.username }}</small>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="badge rounded-pill 
              {% if item.status == 'pending' %} bg-warning text-dark
              {% elif item.status == 'approved' %} bg-success
              {% elif item.status == 'rejected' %} bg-danger
              {% endif %}">
            {{ item.status|capitalize }}
          </span>

          <!-- Preview -->
          <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#previewModal{{ item.id }}">Preview</button>

          {% if item.status == 'pending' %}
          <!-- Approve Trigger -->
          <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#approveModal{{ item.id }}">Approve</button>

          <!-- Reject Trigger -->
          <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal{{ item.id }}">Reject</button>
          {% endif %}
        </div>
      </li>

      <!-- Approve Modal -->
      <div class="modal fade" id="approveModal{{ item.id }}" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-success text-white">
              <h5 class="modal-title">Confirm Approval</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">Are you sure you want to approve <strong>{{ item.name }}</strong>?</div>
            <div class="modal-footer">
              <form method="POST" action="{{ url_for('update_item_status') }}">
                <input type="hidden" name="item_id" value="{{ item.id }}">
                <input type="hidden" name="status" value="approved">
                <button type="submit" class="btn btn-success">Yes, Approve</button>
              </form>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Reject Modal -->
      <div class="modal fade" id="rejectModal{{ item.id }}" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title">Confirm Rejection</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">Are you sure you want to reject <strong>{{ item.name }}</strong>?</div>
            <div class="modal-footer">
              <form method="POST" action="{{ url_for('update_item_status') }}">
                <input type="hidden" name="item_id" value="{{ item.id }}">
                <input type="hidden" name="status" value="rejected">
                <button type="submit" class="btn btn-danger">Yes, Reject</button>
              </form>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Preview Modal -->
      <div class="modal fade" id="previewModal{{ item.id }}" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">{{ item.name }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              {% if item.image_url %}
              <img src="{{ item.image_url }}" class="img-fluid rounded mb-3" alt="{{ item.name }}">
              {% endif %}
              <p><strong>Uploader:</strong> {{ item.user.username }}</p>
              <p><strong>Condition:</strong> {{ item.condition }}</p>
              <p><strong>Category:</strong> {{ item.category }}</p>
              <p><strong>Value:</strong> ₦{{ item.value }}</p>
              <p><strong>Description:</strong><br>{{ item.description }}</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      {% else %}
      <li class="list-group-item text-center text-muted">No items found.</li>
      {% endfor %}
    </ul>

    <!-- 📄 Pagination -->
    {% if items.pages > 1 %}
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        <li class="page-item {% if not items.has_prev %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('admin_dashboard', page=items.prev_num, status=status, search=search) }}">Previous</a>
        </li>
        <li class="page-item disabled">
          <span class="page-link">Page {{ items.page }} of {{ items.pages }}</span>
        </li>
        <li class="page-item {% if not items.has_next %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('admin_dashboard', page=items.next_num, status=status, search=search) }}">Next</a>
        </li>
      </ul>
    </nav>
    {% endif %}

  </div>
</div>

{% endblock %}
